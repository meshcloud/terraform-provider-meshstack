# Copilot Instructions for meshStack Terraform Provider

## Repository Overview

This is the official **meshStack Terraform Provider** developed by meshcloud GmbH. It enables Infrastructure as Code (IaC) management of meshStack resources through Terraform by integrating with the meshStack meshObject API.

**Key Information:**
- **Purpose**: Manage meshStack cloud resources (projects, workspaces, tenants, building blocks, etc.) using Terraform
- **API Integration**: Uses the meshStack meshObject API (`/api/meshobjects` endpoints)
- **API Documentation**: https://docs.dev.meshcloud.io/api/index.html#mesh_objects
- **Provider Registry**: https://registry.terraform.io/providers/meshcloud/meshstack/latest/docs
- **License**: MPL-2.0

## Architecture Overview

This provider follows the standard Terraform Provider Plugin Framework pattern:

```
├── main.go                 # Provider entry point
├── internal/provider/      # Provider implementation (resources, data sources)
├── client/                 # API client for meshStack meshObject API  
├── docs/                   # Terraform registry documentation
├── examples/               # Example Terraform configurations
└── templates/              # Documentation templates
```

### API Authentication
The provider authenticates with meshStack using:
- `endpoint`: meshStack API URL (e.g., `https://api.my.meshstack.io`)
- `apikey` & `apisecret`: API credentials for meshStack
- Environment variables: `MESHSTACK_ENDPOINT`, `MESHSTACK_API_KEY`, `MESHSTACK_API_SECRET`

## Directory Structure

### `/internal/provider/`
Contains all Terraform provider implementation:
- **`provider.go`**: Main provider configuration and setup
- **`*_resource.go`**: Resource implementations (Create, Read, Update, Delete)
- **`*_data_source.go`**: Data source implementations (Read-only)
- **Pattern**: Each meshObject type has separate resource and data source files

### `/client/`
meshStack API client implementation:
- **`client.go`**: Core HTTP client with authentication
- **`*.go`**: Individual API client methods for each resource type
- **Authentication**: JWT token-based with automatic refresh
- **API Base Path**: `/api/meshobjects`

### `/docs/`
Terraform registry documentation (auto-generated):
- **`index.md`**: Provider documentation
- **`resources/`**: Resource documentation 
- **`data-sources/`**: Data source documentation

### `/examples/`
Example Terraform configurations for testing and documentation

## Supported Resources & Data Sources

### Resources (Managed via CRUD operations):
- `meshstack_buildingblock` - Building Block assignments (v1)
- `meshstack_building_block_v2` - Building Block assignments (v2, preview)
- `meshstack_project` - meshStack Projects
- `meshstack_project_user_binding` - Project user access bindings
- `meshstack_project_group_binding` - Project group access bindings  
- `meshstack_workspace` - meshStack Workspaces
- `meshstack_workspace_user_binding` - Workspace user access bindings
- `meshstack_workspace_group_binding` - Workspace group access bindings
- `meshstack_tenant_v4` - Tenant resources (v4)
- `meshstack_tag_definition` - Tag definitions

### Data Sources (Read-only):
- All resources above also have corresponding data sources
- `meshstack_projects` - List multiple projects
- `meshstack_tag_definitions` - List tag definitions

## Development Patterns

### Resource Implementation Pattern
Each resource follows this structure:
```go
type resourceName struct {
    client *client.MeshStackProviderClient
}

// Standard Terraform resource interface methods:
func (r *resourceName) Create(ctx context.Context, req resource.CreateRequest, resp *resource.CreateResponse)
func (r *resourceName) Read(ctx context.Context, req resource.ReadRequest, resp *resource.ReadResponse)  
func (r *resourceName) Update(ctx context.Context, req resource.UpdateRequest, resp *resource.UpdateResponse)
func (r *resourceName) Delete(ctx context.Context, req resource.DeleteRequest, resp *resource.DeleteResponse)
func (r *resourceName) Schema(ctx context.Context, req resource.SchemaRequest, resp *resource.SchemaResponse)
```

### API Client Pattern
API clients follow RESTful patterns:
```go
func (c *MeshStackProviderClient) CreateResource(resource ResourceType) (*ResourceType, error)
func (c *MeshStackProviderClient) ReadResource(id string) (*ResourceType, error)  
func (c *MeshStackProviderClient) UpdateResource(resource ResourceType) (*ResourceType, error)
func (c *MeshStackProviderClient) DeleteResource(id string) error
```

### Schema Patterns
Resources use consistent schema structures:
- `api_version` - meshObject API version
- `kind` - meshObject type (e.g., "meshProject", "meshWorkspace")
- `metadata` - Object metadata (name, uuid, timestamps, etc.)
- `spec` - Object specification (user-defined configuration)
- `status` - Object status (system-managed state)

## Building and Testing

### Local Development Setup
```bash
# Build the provider
go build

# Install locally for development  
go install

# Configure Terraform to use local build
# Add to ~/.terraformrc:
provider_installation {
  dev_overrides {
      "meshcloud/meshstack" = "<GOBIN>"
  }
  direct {}
}
```

### Testing
```bash
# Run acceptance tests
TF_ACC=1 go test ./... -v -timeout 120m

# Run specific tests
TF_ACC=1 go test ./internal/provider -v -run TestAccBuildingBlockResource
```

### Documentation Generation
Documentation is auto-generated using terraform-plugin-docs:
```bash
go generate
terraform fmt -recursive ./examples/
```

## Common Development Tasks

### Adding a New Resource
1. Create `*_resource.go` in `/internal/provider/`
2. Implement the resource interface (Create, Read, Update, Delete, Schema)
3. Add API client methods in `/client/`
4. Register resource in `provider.go`
5. Create example in `/examples/resources/*/`
6. Run `go generate` to update documentation

### meshObject API Integration
- All resources are meshObjects with standard structure
- Use consistent error handling and HTTP status checking
- Implement proper authentication token refresh
- Follow meshStack API conventions for CRUD operations

### Versioning Strategy
- Building blocks have v1 and v2 implementations
- Tenants have v4 implementation  
- Preview resources are marked clearly in documentation

## Key Dependencies

- **Terraform Plugin Framework**: Latest stable version for provider development
- **Standard Library**: HTTP client, JSON marshaling, context handling
- **meshStack API**: RESTful API following meshObject patterns

## Troubleshooting

### Common Issues:
- **Authentication**: Verify API key/secret and endpoint URL
- **API Versions**: Ensure correct meshObject API version usage
- **HTTP Status Codes**: Check for 2xx success responses
- **Resource State**: Handle cases where resources are deleted outside Terraform

### Debugging:
- Enable Terraform debug logging: `TF_LOG=DEBUG terraform apply`
- Check API client authentication and token refresh
- Verify resource schema matches API response structure